# 4.xx.x Denial of Service (DoS) - 上限値がない

## 概要

あるロジックがユーザからの数の要求に応じてオブジェクトを生成したり繰り返し処理をしたりする場合、数の上限がないとリソースを大量に消費してしまう可能性があります。

このテストでは、生成されるオブジェクトの個数や処理回数の上限が制御されており、ロジックがDoSを引き起こさないかを検証します。

## 静的テスト

ユーザ入力値によって生成されるオブジェクトの数が変わるロジックを探します。例として次のようなパラメータを挙げます。

- 個数を指定 `params[:num]`, `params[:count]`
- 範囲を指定 `params[:from]` / `params[:to] `
- スペース区切りの検索キーワード `params[:q]`

### 脆弱なコードの例

未検証のユーザ入力値をもとにした個数分のオブジェクトを生成している場合、脆弱な可能性があります。

```ruby
def index
  @articles = Article.limit(params[:num])
```

オブジェクトの生成だけでなく、指定された回数分処理を実行する場合も危険です。

```ruby
def something
  from = params[:from].to_i
  to = params[:to].to_i
  for num in from..to do
    # do something
  end
```

### 安全なコードの例

個数や回数の最大値を制限している場合、安全です。

```ruby
def index
  num = params[:num].to_i
  num = num > 1000 ? 1000 : num
  @articles = Article.limit(num)
```

## 動的テスト

個数や回数を指定していると思われるパラメータの値を増加させて試行を繰り返し、応答時間やコンテンツサイズを観察します。

### 脆弱性がある場合の例

パラメータの値に比例して応答時間やコンテンツサイズが上限なく大きくなる場合、脆弱な可能性が高いです。

|num|応答時間|コンテンツサイズ|
|:--|:--|:--|
|1|50ms|2100|
|10|66ms|3040|
|100|142ms|12003|
|1000|1438ms|103002|
|5000|8326ms|502495|

※不用意にシステムへ負荷をかけないようにするために、いきなり極端に大きな値を試すのではなく、値は徐々に増やして観察するのがよいです。

### 脆弱性がない場合の例

ある一定の値から変化がない場合、上限値が設定されていると判断できるため安全です。

|num|応答時間|コンテンツサイズ|
|:--|:--|:--|
|1|49ms|2100|
|10|68ms|3040|
|100|152ms|12003|
|1000|1407ms|103002|
|5000|1380ms|103002|